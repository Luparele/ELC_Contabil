{% extends 'APP/base.html' %}
{% load app_filters %}

{% block content %}
<div class="container-fluid" style="max-width: 90%; margin: 0 auto;">
<div class="card shadow-sm">
    <div class="card-header">
        <h3 class="mb-0"><i class="bi bi-file-earmark-bar-graph me-2"></i>Relatório de Lançamentos</h3>
    </div>
    <div class="card-body">
        <!-- BOTÕES DE PERÍODO RÁPIDO -->
        <div class="mb-3">
            <h6 class="mb-2"><i class="bi bi-lightning-fill me-2"></i>Períodos Rápidos:</h6>
            <div class="d-flex flex-wrap gap-2">
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="setPeriodoEFiltrar('hoje')">Hoje</button>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="setPeriodoEFiltrar('ontem')">Ontem</button>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="setPeriodoEFiltrar('semana')">Esta Semana</button>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="setPeriodoEFiltrar('mes')">Este Mês</button>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="setPeriodoEFiltrar('mes_passado')">Mês Passado</button>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="setPeriodoEFiltrar('trimestre')">Trimestre</button>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="setPeriodoEFiltrar('ano')">Este Ano</button>
            </div>
        </div>
        <hr>
        
        <!-- Formulário de Filtros (sem alterações) -->
        <form method="GET" action="{% url 'relatorios' %}" class="mb-4">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="data_inicio" class="form-label">Data de Início</label>
                    <input type="date" class="form-control" id="data_inicio" name="data_inicio" value="{{ data_inicio_value|default:'' }}">
                </div>
                <div class="col-md-3">
                    <label for="data_fim" class="form-label">Data Final</label>
                    <input type="date" class="form-control" id="data_fim" name="data_fim" value="{{ data_fim_value|default:'' }}">
                </div>
                <div class="col-md-2">
                    <label for="tipo_lancamento" class="form-label">Tipo</label>
                    <select class="form-select" id="tipo_lancamento" name="tipo_lancamento">
                        <option value="">Todos</option>
                        <option value="R" {% if tipo_lancamento_value == 'R' %}selected{% endif %}>Receitas</option>
                        <option value="D" {% if tipo_lancamento_value == 'D' %}selected{% endif %}>Despesas</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="categoria" class="form-label">Categoria</label>
                    <select class="form-select" id="categoria" name="categoria">
                        <option value="">Todas</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <div class="d-grid gap-2 d-md-flex">
                        <button type="submit" name="action" value="filtrar" class="btn btn-primary"><i class="bi bi-funnel-fill me-1"></i>Filtrar</button>
                        <a href="{% url 'relatorios' %}" class="btn btn-secondary"><i class="bi bi-arrow-counterclockwise me-1"></i>Limpar</a>
                    </div>
                </div>
            </div>
        </form>

        <hr>

        <!-- SEÇÃO DE RESULTADOS CONDICIONAL -->
        {% if filtros_aplicados %}
            <!-- Ações e Cabeçalho do Período -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">
                    Exibindo resultados para o período de
                    <strong>{{ data_inicio_fmt }}</strong> a <strong>{{ data_fim_fmt }}</strong>
                </h4>
                <div>
                    <a href="#" id="export-excel-btn" class="btn btn-success me-2">
                        <i class="bi bi-file-earmark-excel-fill me-2"></i>EXCEL
                    </a>
                    <a href="#" id="export-pdf-btn" class="btn btn-danger">
                        <i class="bi bi-file-earmark-pdf-fill me-2"></i>PDF
                    </a>
                </div>
            </div>

            <!-- Resumo -->
            <div class="row mb-3">
                <div class="col-md-4">
                    <div class="card bg-success-subtle border-success">
                        <div class="card-body text-center">
                            <h6 class="card-subtitle mb-2 text-muted"><i class="bi bi-wallet2 me-2"></i>Receitas no Período</h6>
                            <p class="card-text fs-5 fw-bold text-success">R$ {{ total_receitas|format_currency }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-danger-subtle border-danger">
                        <div class="card-body text-center">
                            <h6 class="card-subtitle mb-2 text-muted"><i class="bi bi-receipt me-2"></i>Despesas no Período</h6>
                            <p class="card-text fs-5 fw-bold text-danger">R$ {{ total_despesas|format_currency }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h6 class="card-subtitle mb-2 text-muted"><i class="bi bi-bar-chart-line me-2"></i>Balanço do Período</h6>
                            <p class="card-text fs-5 fw-bold {% if balanco >= 0 %}text-success{% else %}text-danger{% endif %}">
                                R$ {{ balanco|format_currency }}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tabela de Resultados -->
            <!-- View Desktop -->
            <div class="d-none d-lg-block">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th scope="col"><i class="bi bi-calendar-date me-2"></i>Data</th>
                            <th scope="col"><i class="bi bi-card-text me-2"></i>Descrição</th>
                            <th scope="col"><i class="bi bi-tags me-2"></i>Categoria</th>
                            <th scope="col"><i class="bi bi-person me-2"></i>Fornecedor</th>
                            <th scope="col"><i class="bi bi-file-text me-2"></i>CNPJ/CPF</th>
                            <th scope="col" class="text-end"><i class="bi bi-currency-dollar me-2"></i>Valor (R$)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for lancamento in lancamentos %}
                        <tr>
                            <td data-label="Data">{{ lancamento.data|date:"d/m/Y" }}</td>
                            <td data-label="Descrição">{{ lancamento.descricao }}</td>
                            <td data-label="Categoria">{{ lancamento.categoria.nome|default:"-" }} ({{ lancamento.categoria.get_tipo_display|default:"-" }})</td>
                            <td data-label="Fornecedor">{{ lancamento.fornecedor.nome|default:"-" }}</td>
                            <td data-label="CNPJ/CPF">{{ lancamento.fornecedor.cpf_cnpj|default:"-" }}</td>
                            {% if lancamento|class_name == 'Receita' %}
                                <td data-label="Valor" class="text-end text-success fw-bold">+ {{ lancamento.valor|format_currency }}</td>
                            {% else %}
                                <td data-label="Valor" class="text-end text-danger fw-bold">- {{ lancamento.valor|format_currency }}</td>
                            {% endif %}
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center py-4"><i class="bi bi-info-circle me-2"></i>Nenhum lançamento encontrado para os filtros selecionados.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- View Mobile (Cards) -->
            <div class="d-lg-none">
                {% for lancamento in lancamentos %}
                <div class="card mb-3 shadow-sm {% if lancamento|class_name == 'Receita' %}border-success{% else %}border-danger{% endif %}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">{{ lancamento.descricao }}</h6>
                                <small class="text-muted">
                                    <i class="bi bi-calendar-date"></i> {{ lancamento.data|date:"d/m/Y" }}
                                </small>
                            </div>
                            <div class="text-end">
                                {% if lancamento|class_name == 'Receita' %}
                                    <strong class="text-success">+ {{ lancamento.valor|format_currency }}</strong>
                                {% else %}
                                    <strong class="text-danger">- {{ lancamento.valor|format_currency }}</strong>
                                {% endif %}
                            </div>
                        </div>
                        <button class="btn btn-sm btn-outline-secondary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#rel{{ lancamento.pk }}" aria-expanded="false">
                            <i class="bi bi-chevron-down"></i> Ver Detalhes
                        </button>
                        
                        <!-- Conteúdo Expansível -->
                        <div class="collapse" id="rel{{ lancamento.pk }}">
                            <hr class="my-2">
                            <div class="row g-2">
                                <div class="col-12">
                                    <small class="text-muted"><i class="bi bi-tags"></i> Categoria:</small><br>
                                    <span>{{ lancamento.categoria.nome|default:"-" }}</span>
                                    <span class="badge bg-secondary ms-1">{{ lancamento.categoria.get_tipo_display|default:"-" }}</span>
                                </div>
                                {% if lancamento.fornecedor %}
                                <div class="col-12">
                                    <small class="text-muted"><i class="bi bi-person"></i> Fornecedor:</small><br>
                                    <span>{{ lancamento.fornecedor.nome }}</span>
                                </div>
                                {% if lancamento.fornecedor.cpf_cnpj %}
                                <div class="col-12">
                                    <small class="text-muted"><i class="bi bi-file-text"></i> CPF/CNPJ:</small><br>
                                    <span>{{ lancamento.fornecedor.cpf_cnpj }}</span>
                                </div>
                                {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-4">
                    <i class="bi bi-info-circle me-2"></i>Nenhum lançamento encontrado para os filtros selecionados.
                </div>
                {% endfor %}
            </div>
        {% else %}
            <!-- Mensagem de Carregamento Inicial -->
            <div class="text-center py-5">
                <i class="bi bi-funnel" style="font-size: 3rem; color: #6c757d;"></i>
                <h4 class="mt-3">Gere seu Relatório</h4>
                <p class="text-muted">Utilize os filtros acima para buscar os lançamentos desejados.</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Script do filtro e exportação -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const categoriasPorTipo = JSON.parse('{{ categorias_json|safe }}');
        const tipoSelect = document.getElementById('tipo_lancamento');
        const categoriaSelect = document.getElementById('categoria');
        const categoriaIdSelecionada = "{{ categoria_id_value|default:'' }}";
        
        function atualizarCategorias() {
            const tipoSelecionado = tipoSelect.value;
            categoriaSelect.innerHTML = '<option value="">Todas</option>';
            if (tipoSelecionado) {
                const categorias = categoriasPorTipo[tipoSelecionado];
                categorias.forEach(function(cat) {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.nome;
                    if (cat.id.toString() === categoriaIdSelecionada) {
                        option.selected = true;
                    }
                    categoriaSelect.appendChild(option);
                });
            }
        }

        tipoSelect.addEventListener('change', atualizarCategorias);
        atualizarCategorias();

        const exportExcelBtn = document.getElementById('export-excel-btn');
        const exportPdfBtn = document.getElementById('export-pdf-btn');
        
        if (exportExcelBtn && exportPdfBtn) {
            const form = document.querySelector('form');
            function atualizarLinksExportacao() {
                const params = new URLSearchParams(new FormData(form)).toString();
                const exportExcelUrl = `{% url 'exportar_excel' %}?${params}`;
                exportExcelBtn.href = exportExcelUrl;
                const exportPdfUrl = `{% url 'exportar_pdf' %}?${params}`;
                exportPdfBtn.href = exportPdfUrl;
            }
            form.addEventListener('change', atualizarLinksExportacao);
            form.addEventListener('submit', atualizarLinksExportacao);
            atualizarLinksExportacao();
        }
    });
    
    // FUNÇÃO PARA DEFINIR PERÍODOS RÁPIDOS E FILTRAR AUTOMATICAMENTE
    function setPeriodoEFiltrar(tipo) {
        const hoje = new Date();
        let dataInicio, dataFim;
        
        switch(tipo) {
            case 'hoje':
                dataInicio = dataFim = hoje;
                break;
            case 'ontem':
                const ontem = new Date(hoje);
                ontem.setDate(ontem.getDate() - 1);
                dataInicio = dataFim = ontem;
                break;
            case 'semana':
                const primeiroDiaSemana = new Date(hoje);
                primeiroDiaSemana.setDate(hoje.getDate() - hoje.getDay());
                dataInicio = primeiroDiaSemana;
                dataFim = hoje;
                break;
            case 'mes':
                dataInicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                dataFim = hoje;
                break;
            case 'mes_passado':
                dataInicio = new Date(hoje.getFullYear(), hoje.getMonth() - 1, 1);
                dataFim = new Date(hoje.getFullYear(), hoje.getMonth(), 0);
                break;
            case 'trimestre':
                const mesAtual = hoje.getMonth();
                const inicioTrimestre = Math.floor(mesAtual / 3) * 3;
                dataInicio = new Date(hoje.getFullYear(), inicioTrimestre, 1);
                dataFim = hoje;
                break;
            case 'ano':
                dataInicio = new Date(hoje.getFullYear(), 0, 1);
                dataFim = hoje;
                break;
        }
        
        // Formatar datas para YYYY-MM-DD
        const formatarData = (data) => {
            const ano = data.getFullYear();
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const dia = String(data.getDate()).padStart(2, '0');
            return `${ano}-${mes}-${dia}`;
        };
        
        // Preencher campos
        document.getElementById('data_inicio').value = formatarData(dataInicio);
        document.getElementById('data_fim').value = formatarData(dataFim);
        
        // Criar um campo hidden para o action=filtrar
        const form = document.querySelector('form[method="GET"]');
        if (form) {
            // Remover action anterior se existir
            const oldAction = form.querySelector('input[name="action"]');
            if (oldAction) {
                oldAction.remove();
            }
            
            // Adicionar novo campo action
            const actionInput = document.createElement('input');
            actionInput.type = 'hidden';
            actionInput.name = 'action';
            actionInput.value = 'filtrar';
            form.appendChild(actionInput);
            
            // Submeter formulário
            form.submit();
        }
    }
</script>
</div>
{% endblock %}