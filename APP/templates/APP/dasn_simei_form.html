{% extends 'APP/base.html' %}

{% block content %}
<div class="card shadow-sm">
    <div class="card-header">
        <h3 class="mb-0">
            <i class="bi bi-file-earmark-text me-2"></i>
            {% if editando %}Editar{% else %}Adicionar{% endif %} DASN-SIMEI
        </h3>
    </div>
    <div class="card-body">
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.ano_calendario.id_for_label }}" class="form-label">
                        {{ form.ano_calendario.label }} <span class="text-danger">*</span>
                    </label>
                    {{ form.ano_calendario }}
                    {% if form.ano_calendario.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.ano_calendario.errors }}
                        </div>
                    {% endif %}
                    <small class="form-text text-muted">{{ form.ano_calendario.help_text }}</small>
                </div>

                <div class="col-md-6 mb-3">
                    <label for="{{ form.valor_bruto_anual.id_for_label }}" class="form-label">
                        {{ form.valor_bruto_anual.label }} <span class="text-danger">*</span>
                    </label>
                    {{ form.valor_bruto_anual }}
                    {% if form.valor_bruto_anual.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.valor_bruto_anual.errors }}
                        </div>
                    {% endif %}
                    <small class="form-text text-muted">{{ form.valor_bruto_anual.help_text }}</small>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="form-check">
                        {{ form.declarada }}
                        <label class="form-check-label" for="{{ form.declarada.id_for_label }}">
                            {{ form.declarada.label }}
                        </label>
                    </div>
                    <small class="form-text text-muted">{{ form.declarada.help_text }}</small>
                    {% if form.declarada.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.declarada.errors }}
                        </div>
                    {% endif %}
                </div>

                <div class="col-md-6 mb-3">
                    <label for="{{ form.data_envio.id_for_label }}" class="form-label">
                        {{ form.data_envio.label }}
                    </label>
                    {{ form.data_envio }}
                    {% if form.data_envio.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.data_envio.errors }}
                        </div>
                    {% endif %}
                    <small class="form-text text-muted">{{ form.data_envio.help_text }}</small>
                </div>
            </div>

            <div class="mb-3">
                <label for="{{ form.comprovante_pdf.id_for_label }}" class="form-label">
                    {{ form.comprovante_pdf.label }}
                </label>
                {{ form.comprovante_pdf }}
                {% if editando and dasn.comprovante_pdf %}
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="bi bi-file-earmark-pdf text-danger"></i>
                            Arquivo atual: <a href="{{ dasn.comprovante_pdf.url }}" target="_blank">{{ dasn.comprovante_pdf.name }}</a>
                        </small>
                    </div>
                {% endif %}
                {% if form.comprovante_pdf.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.comprovante_pdf.errors }}
                    </div>
                {% endif %}
                <small class="form-text text-muted">{{ form.comprovante_pdf.help_text }}</small>
            </div>

            <div class="mb-3">
                <label for="{{ form.observacoes.id_for_label }}" class="form-label">
                    {{ form.observacoes.label }}
                </label>
                {{ form.observacoes }}
                {% if form.observacoes.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.observacoes.errors }}
                    </div>
                {% endif %}
                <small class="form-text text-muted">{{ form.observacoes.help_text }}</small>
            </div>

            <div class="d-flex justify-content-between mt-4">
                <a href="{% url 'ver_perfil' %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left me-1"></i> Cancelar
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save me-1"></i> Salvar
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Habilitar/desabilitar campo data_envio baseado no checkbox declarada
document.getElementById('{{ form.declarada.id_for_label }}').addEventListener('change', function() {
    const dataEnvioField = document.getElementById('{{ form.data_envio.id_for_label }}');
    if (this.checked) {
        dataEnvioField.removeAttribute('disabled');
        dataEnvioField.focus();
    } else {
        dataEnvioField.value = '';
    }
});

// Validação do ano (não pode ser futuro)
document.getElementById('{{ form.ano_calendario.id_for_label }}').addEventListener('change', function() {
    const currentYear = new Date().getFullYear();
    const selectedYear = parseInt(this.value);
    
    if (selectedYear > currentYear) {
        alert('O ano não pode ser maior que o ano atual (' + currentYear + ')');
        this.value = currentYear;
    }
});
</script>
{% endblock %}
